---
title: "Gene Coexpression Networks"
output: html_document
---

## Problem approach and initial preparations

In order to do this assignment, a number of custom functions were created. This are located in the file named "EnrichmentAnnotationFunctions.R". There are three functions, whose description is as follows:

*Celltype_annotator*: It takes two input parameters, a data.frame with the annotations generated by *CoExpNets::cellTypeByModule* and the name of the module of interest. It returns a data.frame with the celltypes associated with the given module.

*Functional_annotator*: Similarly to the previous one, it takes in a data.frame with the annotations generated by *CoExpNets::getGProfilerOnNet* and a module name butreturns a list of data.frames with the top 10 most significant annotations based on the p-values, one for each kind of annotation (BP, MF, CC, Kegg, Reactome).

*Topmm_genextractor*: It takes as input parameters a data.frame generated by the function *getMM* applied to all genes in the dataset, the name of the module and a cutoff value to control how many genes are returned. The output consists of a data.frame with as many genes as specified in cutoff and the gene names in both Ensembl and GeneName encoding as well as the actual values of Module Membership of the genes

Appart from these functions, only the packages CoExpNets, CoExpROSMAP and WGCNA were used.

## Library loading

Now the mentioned packages were loaded as well as the file with the custom functions.

```{r}
####Change to desired working directory####
setwd("/home/albert/Bioinfo/MachineLearning/TareasFinales")
library(CoExpNets)
library(CoExpROSMAP)
library(WGCNA)
source("EnrichmentAnnotationFunctions.R")
```

## Data acquisition and visualization
First, the CoExpROSMAP database was initialized :

```{r}
CoExpROSMAP::initDb()
```

Now we verified which data are available in it

```{r}
for(data.family in getNetworkCategories()){
  cat(paste0("Family of gene expression dataset ",data.family," available\n"))#Data family name
  tissues = getAvailableNetworks(data.family)
  for(tissue in tissues){#Names of the datasets. Ad means Alzheimer disease"
    cat(paste0("Gene expression profiling dataset for tissue ",tissue,"\n is ",
               getExprDataFromTissue(which.one=data.family,tissue=tissue,only.file = T)," available\n"))
  }
}
```

In this assignment only the last dataset, called allsamples was used. This one includes subjects with and without Alzheimer disease. Every dataset has already been preprocessed, as can be inferred from the directory names which includes FPKM, a normalization technique applied to transcriptomic data.

```{r}
expr_data<-getExprDataFromTissue(tissue = "allsamples", which.one = "CoExpROSMAP")
dim(expr_data)
```

Next comes the retrieval of the metadata, which includes several covariables, some technical such as post mortem interval (pmi) and other with biological significance to the Alzheimer disease.

```{r}
metadata<-CoExpROSMAP::getCovariates(tissue="allsamples", which.one="CoExpROSMAP")
```

The covariable braaksc is the one that describes the state of progression of the disease. In a simple barplot we visualized the distribution of the values of braaksc, which there are 7 of, across the individuals from every data available in the databse. 

```{r}
nets<-getAvailableNetworks("CoExpROSMAP")
par(mfrow=c(2,2))
devnull<-lapply(nets, function(x){
  covs<-CoExpROSMAP::getCovariates(tissue=x, which.one = "CoExpROSMAP")
  barplot(table(covs$braaksc),main=paste("Braak stage in", x, sep = " "))
  return(covs)
})
par(mfrow=c(1,1))
```
The levels 4 and 5 are the most prominent in all data set, which means that these values are not particulary correlated with the disease even though they are the most frequent values in both ad and probad dataset. This covariable alone is not sufficient to classify the individuals, more information is needed, such as the one provided by gene expression.

## Data filtering

In this project only the individuals with a braaksc value equal to 5 or 6 were included in the analysis. So we selected the appropiate rows of the dataset as following: 

```{r}
rowstoinclude<-rownames(metadata)[c(which(metadata$braaksc==5), which(metadata$braaksc==6))]
expr_data<-expr_data[rownames(expr_data) %in% rowstoinclude,]
```
## Network creation 

Now that the data is ready, we used the function *CoExpNets::getDownstreamNetwork* to create the coexpression network. The function uses unsupervised learning alogorithms to create modules of genes with similar expression patterns. Since the computation is time-consuming, we allowed the possibilty to load the .rds object with the network if it has already been created once, to avoid executing this function. All the results of the analysis that were be performed were saved in a directory named CoexpressionResults, which is created in the current working directory.

```{r}
#####Change to FALSE if first time###################
loadnetwork<-TRUE                                   #
#####################################################
if(loadnetwork==FALSE){#Avoid executing twice 
  system("mkdir CoexpressionResults")
  expr_network<-CoExpNets::getDownstreamNetwork(tissue = "MyRosMap",
                                              n.iterations = 20,
                                              net.type = "signed",
                                              debug = FALSE,
                                              expr.data = expr_data,
                                              job.path = "./CoexpressionResults")
}else{
  expr_network<-readRDS("./CoexpressionResults/netMyRosMap.13.it.20.rds")
}
networkname<-"./CoexpressionResults/netMyRosMap.13.it.20.rds"
```
Before continuing with the annotation of the network, a small formatting needs to be done. Some genes are encoded with their Ensembl accesion number followed by a '.' and another number. These last two elements must be removed in order to succesfully apply the annotation functions to the network object.
```{r}
names(expr_network$moduleColors)<-gsub(pattern = "\\.\\d+", replacement = "", 
                                       perl = TRUE, names(expr_network$moduleColors))
```
## Network annotation

Three types of annotations of the network's modules were performed. Firstly, a functional annotation of Gene Ontology terms, including all three of them, that is biokogical process (BP), molecular function (MF) and cellular component (CC). Additionally, Reactome and Kegg annotations were obtained. Afterwards, a cellular type enrichment was computed and finally, the correlation and with the covariables of the metadata and its significance was calculated.

### Functional annotation

The function *CoExpNets::getGProfilerOnNet* was used. It generates a data.frame with all the annotations found for each module, its type and statistical significance. The function *CoExpNets::getDownstreamNetwork* used beforehand also generates as default a similar output, but it is not identical to the one created here. Hence, to distinguish them , this output file ends with *"gprofII"*. The function make use of the package gprofiler to obtain the annotation terms.

```{r}
go_data<-CoExpNets::getGProfilerOnNet(net.file=networkname, exclude.iea=FALSE, out.file=paste(
  networkname, "gprofII.csv", sep = "_"))
```
### Cellular type enrichment

The function *CoExpNets::cellTypeByModule* was employed this time. It generates a .pdf file with the enrichment plot, where it can be seen which cellular type are the modules enriched in and the significance of the association, the more intense the color, the more significant it is. It also returns an object of type matrix which contains the information used to produce the aforementioned plot. 
In a similar fashion to the previously done functional annotaion, the *CoExpNets::getDownstreamNetwork* creates by default a .csv file with the information of the enrichment, but it is also not identical to the one computed here. Therefore, this one was saved directly as "CelltypeCorrelation.csv" to the output directory

```{r}
CoExpNets::initDb()
cells_data<-CoExpNets::cellTypeByModule(return.processed = FALSE,
                                        tissue="MyRosMap",
                                        which.one = "new",
                                        plot.file=paste(networkname,".celltype.pdf", sep = "_"),
                                        net.in=networkname,
                                        legend="ROS/MAP cell type signals")
cells_data<-as.data.frame(cells_data)#Now it can be worked with normally
write.csv(cells_data, "./CoexpressionResults/CelltypeCorrelation.csv", quote = FALSE)
```
### Correlation significance with the covariables

This time, the function *CoExpNets::corWithCatTraits* was utilized. It requires as input that the covariables, which are stored as a data.frame in metadata, are ordered identically as the samples are in the expression data used to obtain the coexpression network. The output of the function includes a .pdf file with a heatmap plot showing the significance of the correlation as -log10(p-value). The data.frame that contains the values represented in the plot was also saved as a .csv file

```{r}
filt_metadata<-metadata[rowstoinclude, ]
m<-match(rownames(expr_data), rownames(filt_metadata))
filt_metadata<-filt_metadata[m,]
stopifnot(identical(rownames(expr_data),rownames(filt_metadata)))#Make sure they are identical
covarCorr_data<-CoExpNets::corWithCatTraits(which.one="new", tissue=networkname,
                                            covs=filt_metadata,
                                            covlist = colnames(metadata))
write.csv(covarCorr_data, file = "./CoexpressionResults/CovariableCorrelation.csv", quote = FALSE)
```

## Module visualization

Prior to the analysis of the modules, a quick visualization of some of their features was performed. This included their size, the correlation between them and their hierarchical relationships.

To plot the size, the function *CoExpNets::plotModSizes* is used. The size is represented as a barplot. The height of the bars corresponds to the number of gene that consititutes each module

```{r}
CoExpNets::plotModSizes(tissue=networkname,which.one="new")
```
To see the correlation of the modules, first a so called Eigengene of each module were calculated, using the function *getNetworkEigengenes*. This is not a true gene, rather is a variable constructed by performing PCA with the gene expression values of the modules. To be precise, is the first component of the PCA, and therefore is a "theoretical" gene that represents the best the whole module.
First we showd the correlation with a corrplot, and then a hierarchical cluster as a dendogram, using *plotEGClustering*

```{r}
library(corrplot)
egs<-getNetworkEigengenes(which.one="new",tissue=networkname)
corrplot(cor(egs), type = "upper", tl.cex = 0.5, order='hclust')
plotEGClustering(which.one="new",tissue=networkname)
```
The correlated modules appear close together in the dendogram.

La correlación de módulos con las variables deja ver una clara relación entre los módulos y el intervalo post-mortem, que es una variable técnica, que no tiene relación con la parte biológica. Es significancia de correlación. A partir de 1.3 es significativo, nosotros lo hemos puesto en 2.

## Seleccion de modulos

Basados en correlacion con covariables. 
```{r}
selectModules<-as.character(sapply(1:nrow(covarCorr_data), function(x){
  if(length(which((covarCorr_data[x,]>2))) > 0){ #Coge los modulos que tengan corr > 2 en CUALQUIER covariable
    return(rownames(covarCorr_data)[x])
  }
}))
selectModules<-selectModules[selectModules!="NULL"]
```


Basados en numero de terminos de anotación
Se escogen los 4 módulos que tengan un mayor número de ¿términos anotados?
```{r}
term_matrix<-as.matrix(sort(table(go_data$query.number), decreasing = TRUE))
selectModulesII<-as.character(rownames(term_matrix)[1:4])
```

Se guardan juntos todos los módulos a analizar y los distintos tipos de anotaciones. 
```{r}
totalmod<-c(selectModules, selectModulesII)
annotations <- c("CC","MF","BP","keg","rea", "celltype")
```

## Analisis de los modulos 

Se hace un bucle iterando por cada módulo y por cada anotación para obtener todas las anotaciones de todos los módulos. 
```{r}
annot_list <- lapply(totalmod, function(x){
  aux_list <- lapply(annotations,function(y){
    if(y != "celltype"){
      return(functional_annotator(data=go_data, modulename = x, annot_type = y))
    }else{
      return(celltype_annotator(data = cells_data, modulename = x))
    }
  })
  names(aux_list) <- annotations
  return(aux_list)
  })
names(annot_list) <- totalmod
```

Se obtiene una lista con todos los módulos, que a su vez cada uno tiene 6 listas que son cada una de las anotaciones. 
Se procede a la extracción de los genes con el MM más alto de cada módulo para su análisis.
```{r}
mm<-getMM(tissue = networkname, which.one = "new", genes = colnames(expr_data),
          expr.data.file = expr_data) #Extrae el mm de todos los genes
TopGenes_list<-lapply(totalmod, function(x){
  df<-topmm_genextractor(mmdata = mm, modulename = x, cutoff = 5)
  return(df)
})
names(TopGenes_list)<-totalmod
```


## Descripción de los módulos

### Thistle1

Este módulo está formado por genes relacionados con la mitocondria, concretamente con la membrana interna y los complejos proteicos que allí se hayan. Funcionalmente están relacionados con el transporte de electrones y la síntesis de ATP. También están relacionados con enfermedades neurodegenerativas tales como el Alzheimer, el Parkinson y la enfermedad de Huntington. Estas enfermedades guardan relación con alteraciones en la función de las mitocondrias que están relacionadas tanto con la producción de energía como con la apoptosis y la generación de ROS (Reactive Oxygen Species) que causan estrés oxidativo, si bien en ninguna de las tres se sabe completamente el mecanismo molecular que las origina. (Moreira _et al_, 2010) .A nivel celular, los genes de este módulo están asociados a las neuronas, que son el tipo celular más importante en la patología del Alzheimer.

El gen con mayor MM (Module Membership) es APOO, codificante de la apolipoproteína O, que tiene relación con la formación de puntos de contacto entre mitocondrias y en la organización estructural de las crestas mitocondriales. 

Los cuatro otros genes con mayor MM son  SLC30A5, un transportador de Zinc; UPRT, una enzima uracil-fosforibosil-transferasa; LEO1, componente del complejo activador de la transcripción dependiente de la ARN polimerasa II; y IFTAP, 	una proteína asociada al transporte intraflagelar. Las funciones de estos genes no están muy relacionadas con el resto de anotaciones del módulo.

### Royalblue

Este módulo contiene genes relacionados con la membrana y orgánulos membranosos. Su función es la de receptores, que se unen a diversas moléculas como proteínas de la matriz extracelular, citoquinas y péptidos como el TNF(Tumor Necrosis Factor). Consecuentemente están implicados en varias rutas de señalización que dependen de algún receptor de membrana que detecte una señal. Aparece la respuesta a citoquinas, a otras interleuquinas, al TNF, al HIF (Hypoxia Inducible Factor),la citotoxicidad causada por acción de linfocitos NK. Relacionado con el sistema inmune aparece también la desgranulación de los neutrófilos. Estas rutas desencadenan entre otras respuestas la apoptosis y la inflamación. La apoptosis de células nerviosas y la inflamación ocurren en el transcurso de las enfermedades neurodegenerativas, incluido el Alzheimer. También es interesante el enriquecimiento encontrado en el tipo celular microglial, ya que estas células son de origen mieloide, es decir, provienen de macrófagos, células con actividad fagocítica y presentadora de antígenos entre otras. Dentro del tejido nervioso, se diferencian a microglia y cumplen estas funciones inmunitarias, fagocitando cuerpos extraños como células apoptóticas y placas amiloides que se forman en el Alzheimer. Existen estudios que relacionan las células microgliales con el origen de la enfermedad (Hemonnot _et al_. 2018)

Los 5 genes con mayor MM del módulo son HYAL2, una enzima hialurodinasa liposomal, ICAM2, una proteína de unión intercelular, DGKH, una enzima diacilglicerol quinasa inducida ante glucocorticoides, CPD, una carboxipeptidasa y SNAI1, un represor transcripcional. 
Los funciones más relevantes en relación con las anotaciones anteriormente comentadas son la de ICAM2, que participa en la unión entre células, algo que forma parte de las funciones de las células microgliales, DGKH, porque regula los niveles de un segundo mensajero como es el diacilglicerol implicado en múltiples rutas de señalización.

### Tan

Este módulo contiene genes que actúan como factores de transcripción, encontrándose por tanto dentro del núcleo concretamente en el nucleoplasma. Tienen relación con reacciones anbólicas y biosíntesis de macromoléculas. Aparecen asociados a algunas rutas de señalización como la de las MAP quinasas, el TGF (Tumor Growth Factor).  Existen estudios que relacionan una deficiencia en la señalización dependiente de TGF con el Alzheimer (Hu _et al_., 2019).  De modo particularmente interesante aparecen asociados a diversos tipos de cáncer, como el de pulmón, colorectal, de pecho y de tiroides; así como al virus de la leucemia humano que causa también cáncer como consecuencia de su ciclo de replicación.  Existen también estudios que hablan de una correlación inversa entre el cáncer y el Alzheimer, pues el cancer está causado por una proliferación descontrolada de las células y el Alzheimer por la causa opuesta, un aumento de la muerte celular. (Anne Feng _et al_. , 2017). El tipo celular asociado a los genes de este módulo vuelve a ser la microglia.

Los tres genes con mayor MM son TBC1D10, una proteína activadora de GTPasa de tipo Rab, que participa en la regulación del transporte de vesículas en oligodendrocitos; OXSR1, una quinasa que se activa como respuesta al estrés oxidativo; y un transcrito no traducido, un ARN no codificante LINC01354 sin función atribuida. De estos tres el más relevante quizás sea OXSR1 debido a su relación con el estrés oxidativo y el papel de este en la apoptosis.

### Darkturquoise

El módulo darkturquoise presenta genes relacionados con rutas de señalización, respuesta inmunitaria a infecciones víricas a través de rutas como la del interferón y proteínas que interaccionan con el RNA. Sus genes se encuentran expresados en el citosol celular. Los tipos celulares asociados a este módulo los los linfocitos T colaboradores (TH) y la microglía, ambos relacionados con el sistema inmunitario. Es interesante el hecho que algunos tipos de virus podrían tener relación con la neuropatología del alzheimer. (Sochocka _et al_ 2017).

CXCL5 es una citoquina de la familia CXC. SAMD9L un gen cuya alteración implica enfermedades que afectan al cerebro como el síndrome de ataxia-pancitopenia. UBA7 es una proteína involucrada en ubiquitinación. PATL2 es un gen que codifica una proteína de unión a ARN, cuya alteración se asocia a problemas de fertilidad.

### Purple

El módulo purple se encuentra enriquecido exclusivamente en mitocondria, sin tipos celulares asociados. Destaca la actividad de cofactor y oxidorreductasa que se encuentra enriquecida. Es interesante que se encuentra involucrado en multitud de procesos metabólicos, incluyendo metabolismo basal y metabolismo de ácidos grasos. Se ha encontrado cierta asociación entre el metabolismo de ácidos grasos y alzheimer (Snowden _et al_ 2017 )

LINC00526 codifica para un RNA largo no codificante. C1orf194 es un gen poco estudiado que se cree que puede causar diferentes enfermedades cerebrales. ZNF706 codifica un factor de transcripción involucrado en la regulación negativa del mantenimiento de la población de células mesenquimales embrionales, además de participar en la regulación negativa de la transcripción RP4-612B15.3 es un pseudogen presente en poblaciones del sistema inmune. TOE1 inhibe el crecimiento celular al parar el ciclo celular.

### Floralwhite

El módulo floralwhite se encuentra relacionado con el sistema inmunitario a nivel de señalización intracelular (señalización de receptores) y extracelular (unión a inmunoglobulina G (Ig G), además de activación de leucocitos mieloides. Se ha encontrado que durante el desarrollo del alzheimer, se produce la expresión de moléculas proinflamatorias en células mieloides (Thome _et al_ 2018). En este módulo se aprecia una relación a nivel de enfermedad y tipo celular, ya que posee enriquecimiento en artritis reumatoide y en diferenciación de osteoclastos, y se ha visto que una actividad excesiva de los osteoclastos se relaciona con la aparición de artritis reumatoide (Nakashima _et al_ 2008). No se encuentra relación entre la artritis reumatoide y el alzheimer (Qixuan _et al_ 2018), por lo que es posible que solamente compartan ese perfil proinflamatorio y por eso queda resaltado en el análisis.



# Bibliografía

Paula I. Moreira , Cristina Carvalho, Xiongwei Zhu,  Mark A. Smith , George Perry : Mitochondrial dysfunction is a trigger of Alzheimer's disease pathophysiology. _Biochimica et Biophysica_ Acta 2010, 1802 2:10

Anne-Laure Hemonnot , Jennifer Hua,  Lauriane Ulmann, and Hélène Hirbec Microglia in Alzheimer Disease: Well-Known Targets and New Opportunities. _Frontiers in Aging Neuroscience_ 2019, 11 233

Yueqiang Hu, Wei Chen, Lin Wu,  Lingfei Jiang , Ni Liang , Lulu Tan , Minghui Liang, Nong Tang: TGF-β1 Restores Hippocampal Synaptic Plasticity and Memory in Alzheimer Model via the PI3K/Akt/Wnt/β-Catenin Signaling Pathway. _Journal of Molecular Neuroscience_ 2019, 67, 142:149. 

Yen-Chen Anne Feng,  Kelly Cho, Sara Lindstrom,  Peter Kraft, Jean Cormack: Investigating the genetic relationship between Alzheimer’s disease and cancer using GWAS summary statistics. _Human Genetics_ 2017, 136, 1341:1351.

Marta Sochocka, Katarzyna Zwolińska, Jerzy Leszek. The Infectious Etiology of Alzheimer’s Disease. _Curr Neuropharmacol_ 2017, 15(7): 996–1009.

Stuart G. Snowden, Amera A. Ebshiana, Abdul Hye, Yang An, Olga Pletnikova, Richard O’Brien, John Troncoso, Cristina Legido-Quigley, Madhav Thambisetty. Association between fatty acid metabolism in the brain and Alzheimer disease neuropathology and cognitive performance: A nontargeted metabolomic study. _PLOS Medicine_ 2017, Mar 21;14(3):e1002266.

Aaron D. Thome, Alireza Faridar, David R. Beers, Jason R. Thonhoff, Weihua Zhao, Shixiang Wen, Belen Pascual, Joseph C. Masdeu,Stanley H. Appel. Functional alterations of myeloid cells during the course of Alzheimer’s disease.  _Molecular Neurodegeneration_ 2018, 13:61 

Qixuan Cai, Zhuoyuan Xin, Lin Zuo, Fan Li, Bin Liu. Alzheimer’s Disease and Rheumatoid Arthritis: A Mendelian Randomization Study.  _Frontiers in Neuroscience_ 2018, 12, 627.
